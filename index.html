<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SleepyTon - Spin & Collect</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { background: #0f172a; color: white; font-family: 'Segoe UI', sans-serif; margin: 0; padding-bottom: 90px; overflow-x: hidden; }
        .page { display: none; padding: 20px; animation: fadeIn 0.3s ease; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .header-card { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); padding: 20px; border-radius: 20px; border: 1px solid #38bdf8; text-align: center; margin-bottom: 20px; position: relative; }
        
        /* EJDERHA KARAKTERÄ° */
        .dragon-container { position: relative; width: 180px; height: 180px; margin: 10px auto; }
        .dragon-img { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 0 15px #38bdf8); animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }

        /* Ã‡ARKIFELEK */
        .wheel-box { position: relative; width: 280px; height: 280px; margin: 25px auto; border-radius: 50%; box-shadow: 0 0 25px rgba(56,189,248,0.5); overflow: hidden; background: #1e293b; }
        #wheel { width: 100%; height: 100%; transition: transform 4s cubic-bezier(0.15, 0, 0.15, 1); }
        .wheel-pointer { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); width: 40px; height: 40px; background: url('https://i.ibb.co/L5p4G7S/pointer.png') no-repeat center center / contain; z-index: 10; filter: drop-shadow(0 3px 6px rgba(0,0,0,0.5)); }
        
        /* Ã–DÃœL KARTI */
        .reward-card { background: #1e293b; padding: 15px; border-radius: 15px; margin-top: 20px; border: 1px solid #38bdf8; text-align: center; }
        .reward-img { width: 80px; height: 80px; object-fit: contain; margin-bottom: 10px; }

        .nav-bar { position: fixed; bottom: 0; width: 100%; background: #1e293b; display: flex; justify-content: space-around; padding: 12px 0; border-top: 2px solid #334155; z-index: 1000; }
        .nav-item { color: #94a3b8; font-size: 11px; display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .nav-item.active-nav { color: #38bdf8; font-weight: bold; }
        
        .btn { background: #38bdf8; color: #0f172a; border: none; padding: 12px; border-radius: 10px; width: 100%; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .item-card { background: #1e293b; padding: 15px; border-radius: 15px; margin-bottom: 10px; border: 1px solid #334155; }
        .list-item { background: rgba(56, 189, 248, 0.1); padding: 10px; border-radius: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

    <div id="page-mine" class="page active">
        <div class="header-card">
            <h3 id="lvl-text" style="margin:0; color:#38bdf8;">Level 1: GenÃ§ Ejderha</h3>
            <div style="font-size: 32px; font-weight: bold; margin:5px 0;"><span id="bakiye">0.00</span> ğŸ’</div>
            <div style="color: #4ade80; font-size:14px;">KazanÃ§: +<span id="hiz">0</span>/saat</div>
        </div>

        <div class="dragon-container">
            <img id="dragon-pic" src="https://img.freepik.com/free-vector/cute-dragon-flying-cartoon-vector-icon-illustration_138676-2131.jpg" class="dragon-img">
        </div>

        <div style="text-align:center;">
            <p style="margin-bottom:5px; color:#f59e0b; font-weight:bold;">ğŸ¡ GÃ¼nlÃ¼k Åans Ã‡arkÄ±</p>
            <div class="wheel-box">
                <div class="wheel-pointer"></div>
                <img id="wheel" src="https://i.ibb.co/fG2h031/wheel-with-icons.png" alt="Ã‡arkÄ±felek" style="width:100%;">
            </div>
            <button id="spin-btn" class="btn" style="width:200px; background:#f59e0b;" onclick="spinWheel()">Ã‡EVÄ°R!</button>
        </div>

        <div id="daily-reward-display" class="reward-card" style="display:none;">
            <h4>ğŸ‰ KazandÄ±n!</h4>
            <img id="reward-icon" class="reward-img" src="">
            <p id="reward-text" style="font-weight:bold; font-size:18px;"></p>
        </div>
    </div>

    <div id="page-leader" class="page"><h3>ğŸ† Liderler</h3><div id="leader-list"></div></div>
    <div id="page-shop" class="page"><h3>ğŸ›’ Market</h3>
        <div class="item-card"><h4>ğŸ£ Bebek Ejderha</h4><p>100 ğŸ’ | +10/saat</p><button class="btn" onclick="satinal(100, 10)">SatÄ±n Al</button></div>
        <div class="item-card"><h4>ğŸ² YetiÅŸkin Ejderha</h4><p>1.000 ğŸ’ | +150/saat</p><button class="btn" onclick="satinal(1000, 150)">SatÄ±n Al</button></div>
    </div>
    <div id="page-ref" class="page"><h3>ğŸ‘¥ ArkadaÅŸlar</h3>
        <div class="item-card"><p id="ref-link-box" style="font-size:10px;"></p><button class="btn" onclick="copyLink()">Kopyala</button></div>
        <div id="friend-list"></div>
    </div>
    <div id="page-wallet" class="page"><h3>ğŸ’° CÃ¼zdan</h3>
        <div class="item-card"><h2 id="bakiye-wallet">0.00</h2><input id="wallet-addr" placeholder="TON Adresi"><button class="btn" onclick="talepGonder()">Ã‡ekim Ä°ste</button></div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active-nav" onclick="tab('page-mine', this)"><span>â›ï¸</span>Maden</div>
        <div class="nav-item" onclick="tab('page-leader', this)"><span>ğŸ†</span>Liderler</div>
        <div class="nav-item" onclick="tab('page-shop', this)"><span>ğŸ›’</span>Market</div>
        <div class="nav-item" onclick="tab('page-ref', this)"><span>ğŸ‘¥</span>ArkadaÅŸ</div>
        <div class="nav-item" onclick="tab('page-wallet', this)"><span>ğŸ’°</span>CÃ¼zdan</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const userId = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : "test_user";
        const userName = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.first_name : "Oyuncu";
        const dbURL = "https://sleepyton-3b15d-default-rtdb.europe-west1.firebasedatabase.app/";
        
        let state = { bakiye: 0, hiz: 0, lastSync: Date.now(), lastSpin: 0, name: userName, friends: [], characters: [] };

        const wheelRewards = [
            { angle: 0, text: "500 ğŸ’", type: "elmas", value: 500, icon: "https://i.ibb.co/9r9fG5x/diamond.png" }, // 0-60 derece
            { angle: 60, text: "+10 HÄ±z", type: "hiz", value: 10, icon: "https://i.ibb.co/Q8Q1m34/speed.png" }, // 60-120 derece
            { angle: 120, text: "ÅÃ¶valye Karakter", type: "karakter", value: "ÅÃ¶valye", icon: "https://i.ibb.co/r71X7Lg/knight.png" }, // 120-180 derece
            { angle: 180, text: "100 ğŸ’", type: "elmas", value: 100, icon: "https://i.ibb.co/9r9fG5x/diamond.png" }, // 180-240 derece
            { angle: 240, text: "+20 HÄ±z", type: "hiz", value: 20, icon: "https://i.ibb.co/Q8Q1m34/speed.png" }, // 240-300 derece
            { angle: 300, text: "1.000 ğŸ’", type: "elmas", value: 1000, icon: "https://i.ibb.co/9r9fG5x/diamond.png" } // 300-360 derece
        ];
        
        function load() {
            fetch(`${dbURL}/users/${userId}.json`).then(r => r.json()).then(data => {
                if(data) state = {...state, ...data};
                update();
                checkSpinStatus();
                document.getElementById('ref-link-box').innerText = `https://t.me/Sleepyton_bot?start=${userId}`;
            });
        }

        let isSpinning = false;
        function spinWheel() {
            if(isSpinning) return;
            if(Date.now() - state.lastSpin < 86400000) return alert("GÃ¼nde sadece 1 kez Ã§evirebilirsin!");

            isSpinning = true;
            const spinBtn = document.getElementById('spin-btn');
            spinBtn.disabled = true;
            spinBtn.innerText = "DÃ¶nÃ¼yor...";

            const randomIndex = Math.floor(Math.random() * wheelRewards.length);
            const reward = wheelRewards[randomIndex];
            const targetAngle = (360 * 5) + (reward.angle + (Math.random() * 50 - 25)); // 5 tam tur + Ã¶dÃ¼l aÃ§Ä±sÄ± + kÃ¼Ã§Ã¼k rastgelelik

            document.getElementById('wheel').style.transform = `rotate(${targetAngle}deg)`;

            setTimeout(() => {
                isSpinning = false;
                spinBtn.disabled = false;
                spinBtn.innerText = "Ã‡EVÄ°R!";
                
                state.lastSpin = Date.now();
                
                let rewardText = "";
                let rewardIcon = "";

                if(reward.type === "elmas") {
                    state.bakiye += reward.value;
                    rewardText = `${reward.value} ğŸ’ KazandÄ±n!`;
                    rewardIcon = reward.icon;
                } else if(reward.type === "hiz") {
                    state.hiz += reward.value;
                    rewardText = `+${reward.value}/saat HÄ±z KazandÄ±n!`;
                    rewardIcon = reward.icon;
                } else if(reward.type === "karakter") {
                    if(!state.characters.includes(reward.value)) {
                        state.characters.push(reward.value);
                        rewardText = `Yeni Karakter: ${reward.value}!`;
                    } else {
                        rewardText = `${reward.value} Zaten sende var! (100 ğŸ’ telafi)`;
                        state.bakiye += 100;
                    }
                    rewardIcon = reward.icon;
                }
                
                document.getElementById('reward-icon').src = rewardIcon;
                document.getElementById('reward-text').innerText = rewardText;
                document.getElementById('daily-reward-display').style.display = 'block';

                update();
                save();
                checkSpinStatus();
            }, 4000);
        }

        function checkSpinStatus() {
            const btn = document.getElementById('spin-btn');
            if(Date.now() - state.lastSpin < 86400000) {
                btn.innerText = "YARIN TEKRAR GEL";
                btn.style.background = "#475569";
                btn.disabled = true;
            } else {
                btn.innerText = "Ã‡EVÄ°R!";
                btn.style.background = "#f59e0b";
                btn.disabled = false;
            }
        }

        function update() {
            document.getElementById('bakiye').innerText = state.bakiye.toFixed(2);
            document.getElementById('bakiye-wallet').innerText = state.bakiye.toFixed(2);
            document.getElementById('hiz').innerText = state.hiz;
            
            let lvlText = "Level 1: GenÃ§ Ejderha";
            let dragonImg = "https://img.freepik.com/free-vector/cute-dragon-flying-cartoon-vector-icon-illustration_138676-2131.jpg";
            if(state.bakiye > 5000) { lvlText = "Level 2: YetiÅŸkin Ejderha"; dragonImg = "https://img.freepik.com/free-vector/fire-dragon-cartoon-sticker-vector_1308-123456.jpg"; }
            if(state.bakiye > 25000) { lvlText = "Level 3: Antik Ejderha"; dragonImg = "https://img.freepik.com/free-vector/dragon-fire-cartoon-vector-icon-illustration_138676-3831.jpg"; }
            
            document.getElementById('lvl-text').innerText = lvlText;
            document.getElementById('dragon-pic').src = dragonImg;

            if(state.friends && state.friends.length > 0) {
                document.getElementById('friend-list').innerHTML = state.friends.map(f => `<div class="list-item">ğŸ‘¤ ${f}</div>`).join('');
            }
        }

        function tab(id, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active-nav'));
            document.getElementById(id).classList.add('active');
            el.classList.add('active-nav');
            if(id === 'page-leader') getRanking();
        }

        function getRanking() {
            fetch(`${dbURL}/users.json`).then(r => r.json()).then(all => {
                let top = Object.values(all).sort((a,b) => b.bakiye - a.bakiye).slice(0,5);
                document.getElementById('leader-list').innerHTML = top.map((u,i) => `<div class="list-item"><span>${i+1}. ${u.name || 'Gizli'}</span> <b>${Math.floor(u.bakiye)} ğŸ’</b></div>`).join('');
            });
        }

        function save() {
            state.lastSync = Date.now();
            fetch(`${dbURL}/users/${userId}.json`, { method: 'PUT', body: JSON.stringify(state) });
        }

        function satinal(f, a) {
            if(state.bakiye >= f) { state.bakiye -= f; state.hiz += a; update(); save(); alert("SatÄ±n alma baÅŸarÄ±lÄ±!"); } else alert("Yetersiz ğŸ’!");
        }
        
        function talepGonder() {
            const addr = document.getElementById('wallet-addr').value;
            if(addr.length < 10) return alert("GeÃ§ersiz TON adresi!");
            if(state.bakiye < 100000) return alert("Minimum 100.000 ğŸ’ gereklidir!");
            const talep = { userId, userName, addr, miktar: state.bakiye, tarih: new Date().toLocaleString() };
            fetch(`${dbURL}/talepler/${userId}.json`, { method: 'PUT', body: JSON.stringify(talep) }).then(() => {
                state.bakiye = 0; save(); update(); alert("âœ… Talebiniz alÄ±ndÄ±!");
            });
        }

        function copyLink() {
            const t = document.createElement('textarea'); t.value = document.getElementById('ref-link-box').innerText;
            document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t);
            alert("KopyalandÄ±!");
        }

        setInterval(() => { if(state.hiz > 0) { state.bakiye += (state.hiz/3600); update(); } }, 1000);
        setInterval(save, 10000);
        window.onload = load;
    </script>
</body>
</html>
